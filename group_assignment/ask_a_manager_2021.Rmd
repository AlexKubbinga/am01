---
title: "Ask A Manager 2021"
author: "Group 5 MAM"
date: "2021-09-16"
output: html_document
---

```{r load-libraries, echo=FALSE, warning=FALSE}
library(tidyverse)
library(janitor) 
library(skimr)
library(countrycode) # to clean up country names
library(broom)
library(car)
library(ggfortify)
library(mosaic)
library(dplyr)

```


```{r}
# load "Ask a A Manager 2021 Survey" googlesheet
# https://www.askamanager.org/
ask_a_manager_2021 <- read_csv(here::here("data","ask_a_manager.csv"))

skimr::skim(ask_a_manager_2021)

```

# Data cleaning (exchange rate: Alex)

remove missing values.

```{r remove-na}
# remove the NA values
ask_a_manager_2021 <- ask_a_manager_2021 %>% 
  filter(!gender %in% c("NA","Other or prefer not to answer","Prefer not to answer") &
           race!="NA" &
           highest_level_of_education_completed!="NA")
```

transform into ordered `factor` datatype

```{r, warning=FALSE}
ask_a_manager_2021 <- ask_a_manager_2021 %>% 
  mutate(
    country = countrycode::countryname(country),
    how_old_are_you = factor(how_old_are_you,levels=c("under 18","18-24","25-34","35-44","45-54","55-64","65 or over")),
    years_of_experience_in_field = factor(years_of_experience_in_field,levels=c("1 year or less","2 - 4 years","5-7 years","8 - 10 years","11 - 20 years","21 - 30 years","31 - 40 years","41 years or more")),
    overall_years_of_professional_experience = factor(overall_years_of_professional_experience,levels=c("1 year or less","2 - 4 years","5-7 years","8 - 10 years","11 - 20 years","21 - 30 years","31 - 40 years","41 years or more")),
    highest_level_of_education_completed = factor(highest_level_of_education_completed, labels=c("High School","Some college","College degree","Master's degree","PhD","Professional degree")),
    log_annual_salary = log(annual_salary)
  ) %>% 
  janitor::clean_names() # clean columns names
```

only keep top 25 industries.

```{r}
# Industry is messy... it has > 1000 different industries.
# we only take top 25 industries into our analytics. (24597(92%) out of 26765 entries)
industry_list <- ask_a_manager_2021 %>% 
  count(industry, sort=TRUE) %>% 
  mutate(percent = 100* n/sum(n)) %>% 
  slice_max(order_by = n, n = 25) %>% 
  select(industry)
ask_a_manager_2021 <- ask_a_manager_2021 %>% 
  filter(industry %in% industry_list$industry)

```

only keep the commonly used currencies and standardize the number

```{r}
# transform all the currencies into USD and only keep the commonly used currencies
# todo (Alex)
ask_a_manager_2021 <- ask_a_manager_2021 %>% 
  filter(industry %in% industry_list$industry &
           currency=="USD" &
           !is.na(country))

# filter out outliers of annual salary
# regression for both datasets
# ask_a_manager_2021 <- ask_a_manager_2021 %>% 
#   filter(annual_salary>1000 & annual_salary<1000000)
# todo

```

```{r}
colnames(ask_a_manager_2021)
```




# Exploratory Data Analysis

## Counts

```{r}
# Some quick counts, groups, etc
ask_a_manager_2021 %>% 
  count(how_old_are_you, sort=TRUE) %>% 
  mutate(percent = 100* n/sum(n))

# 'country' 
ask_a_manager_2021 %>% 
  count(country, sort=TRUE) %>% 
  mutate(percent = 100* n/sum(n))

# 'city' 
ask_a_manager_2021 %>% 
  count(city, sort=TRUE) %>% 
  mutate(percent = 100* n/sum(n))

# highest_level_of_education_completed 
ask_a_manager_2021 %>% 
  count(highest_level_of_education_completed) %>% 
  mutate(percent = 100* n/sum(n))%>% 
  arrange(desc(percent))

# gender
ask_a_manager_2021 %>% 
  count(gender) %>% 
  mutate(percent = 100* n/sum(n))%>% 
  arrange(desc(percent))

# race
ask_a_manager_2021 %>% 
  count(race) %>% 
  mutate(percent = 100* n/sum(n))%>% 
  arrange(desc(percent))

# overall_years_of_professional_experience 
ask_a_manager_2021 %>% 
  count(overall_years_of_professional_experience ) %>% 
  mutate(percent = 100* n/sum(n))%>% 
  arrange(desc(percent))

# years_of_experience_in_field  
ask_a_manager_2021 %>% 
  count(years_of_experience_in_field  ) %>% 
  mutate(percent = 100* n/sum(n))%>% 
  arrange(desc(percent))

```

## Salary (Yuan)

How is salary distributed?

```{r}

# How is salary distributed?
favstats(ask_a_manager_2021$annual_salary) # find a really rich guy here

ask_a_manager_2021 %>% 
  slice_min(order_by = annual_salary,n =nrow(ask_a_manager_2021)-5) %>% # choose a number
  ggplot(aes(x=annual_salary))+
  geom_boxplot()

ask_a_manager_2021 %>% 
  slice_min(order_by = annual_salary,n =nrow(ask_a_manager_2021)-5) %>% # choose a number
  ggplot(aes(x=annual_salary))+
  stat_ecdf()

# taking log is better
ggplot(ask_a_manager_2021, aes(x=log(annual_salary)))+
  geom_density()

```

right skewed distribution. 

## Industry (Yuan)

## Gender vs Industry (Yuan)

## Education (Jean)

```{r Education_salary, warning=FALSE, echo=FALSE}

ask_a_manager_2021 %>% 
  filter(gender %in% c("Man", "Woman")) %>% 
  mutate(sex = factor (gender, labels = c("Man", "Woman"))) %>% 
  rename(Education = highest_level_of_education_completed) %>% 
  group_by(Education, gender) %>% 
  summarise (median_salary_by_edu = median (annual_salary),
             mean_salary_by_edu = mean(annual_salary)) %>% 
  ggplot () +
  geom_col(aes (Education, median_salary_by_edu, fill = gender), position = position_dodge(width = 0.9), alpha = 0.7)+
  geom_point(aes(x = Education, y=mean_salary_by_edu, color = gender))+
  theme_bw()+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+
  NULL


```


## Race (Clara)
### Count 
```{r}
ask_a_manager_2021 %>% 
  group_by(race) %>% 
  filter(n() > 500) %>% 
  summarise(count=n()) %>% 
  ggplot(aes(y=count, x=race, color=race))+
  geom_col() +
  theme(legend.position = "none") +
  labs(x="Race", y="Count", title="Count by Race", subtitle = "Races with > 500 Respondents")+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) + 
  NULL
```
### Mean Salary
```{r}
ask_a_manager_2021 %>% 
  group_by(race) %>% 
  filter(n() > 500) %>% 
  summarise (median_salary_by_race = median (annual_salary),
             mean_salary_by_race = mean(annual_salary)) %>% 
  ggplot(aes(y=median_salary_by_race, x=race, color=race))+
  geom_point() +
  theme(legend.position = "none") +
  labs(x="Race", y="Medium Salary", title="Salary by Race", subtitle = "Races with > 500 Respondents")+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) + 
  NULL

```
### Race and Mean Salary 
```{r}
ask_a_manager_2021 %>% 
  group_by(race) %>% 
  filter(n() > 500) %>% 
  ggplot(aes(y = log(annual_salary), x=race))+
  geom_boxplot() +
  theme_bw()+
  theme(legend.position = "none")+
  labs(title = "Distribution of Annual Salaries by Racial Group",
       x = "Film Rating",
       y = " ")+
  NULL
```

```{r}

```

## Location (Alex)

> MAP

```{r}
# Count by Industry

ask_a_manager_2021 %>% 
  group_by(industry) %>% 
  summarise(count=n()) %>% 
  ggplot(aes(y=fct_reorder(industry,count),x=count))+
  geom_col()

# null hypothesis: no difference between
```

## Age (Raina)


## Experience (Raghav)


# Statistical Tests


## Gender vs Salary (Clara)

### General Statistics & Boxplot
```{r}
mosaic::favstats (annual_salary ~ gender, data=ask_a_manager_2021)

```

```{r}
ask_a_manager_2021 %>% 
  ggplot(aes(x=gender,y=log_annual_salary))+
  geom_boxplot()

ask_a_manager_2021

```
***For our following analysis, we will be comparing data from the male gender "Man" with data from the female gender "Woman." We will filter out the data on those that are non binary.***

### T-Test

```{r, t_test_for_gender_salary} }

ask_a_manager_2021 <- ask_a_manager_2021 %>%
  filter(gender!="Non-binary")
t.test(annual_salary ~ gender, data = ask_a_manager_2021)
```

### Confidence Intervals 
```{r, gender vs. salary confidence intervals}
 
#mosaic::favstats (annual_salary ~ gender, data=ask_a_manager_2021)
ask_a_manager_2021_gender <- ask_a_manager_2021 %>%
  mutate(gender2 = case_when(
  gender  == "Man" ~ "1",
 gender == "Woman" ~ "0",
  TRUE ~ "NA"
)) %>%
  mutate(gender2 = as.numeric(gender2))


mosaic::favstats (annual_salary ~ gender, data=ask_a_manager_2021_gender) %>%
mutate(t_critical = qt(0.975,n-1),
         sd_mean = sd/sqrt(n),
         margin_of_error = t_critical*sd_mean,
         ci_lower = mean-margin_of_error,
         ci_higher = mean+margin_of_error)

```
Observation: Since two 95% confidence intervals do not overlap, we are at least 95% confident that the male have higher salary than the female on average.

### Bootstrap Test 
```{r}
# hypothesis testing using infer package
diff <- ask_a_manager_2021_gender %>%
  specify(annual_salary ~ gender) %>%
  calculate(stat = "diff in means", order = c("Woman", "Man"))

set.seed(1234)
salary_in_null_world <- ask_a_manager_2021_gender %>%
  filter(gender !="Non-binary") %>%
  specify(annual_salary ~ gender) %>%
   # assuming independence of gender and salary
  hypothesize(null = "independence") %>%
   # generate 1000 reps, of type "permute"
  generate(reps = 1000, type = "permute") %>%
  # calculate statistic of difference, namely "diff in means"
   calculate(stat = "diff in means", order = c("Woman", "Man")) 

salary_in_null_world %>% 
  visualise()+
  shade_p_value(obs_stat = diff, direction = "two-sided")
  
p_value <- salary_in_null_world %>% 
  get_pvalue(obs_stat = diff, direction="both")
p_value
```
Observation: Our null hypothesis is that the difference of omega between male and female is 0 and we get a p_value very close to 0. Therefore we reject the null hypothesis with 95% confidence. There is difference between the average male and female salary.


## Gender vs Education (Jean)

We want to look at the relationship between one's gender and education degree. 

```{r t_test_for_gender_education}

ask_a_manager_2021_education <- ask_a_manager_2021 %>% 
  filter(gender !="Non-binary") %>%
  mutate(high_school = if_else(highest_level_of_education_completed == "High School", "Yes", "No")) %>% 
  select(gender,high_school)
  # group_by(gender) %>% 
  # summarise(n=sum(high_school == "Yes"))
  # group_by (gender) %>%
  # summarise (highschool_degree = sum(highest_level_of_education_completed == "High School", na.rm = TRUE)/n())

ask_a_manager_2021_education

prop.test(~gender , data = ask_a_manager_2021_education, success = "Yes")


```




## Race vs Salary (Raina)

> wisely choose the race. like white vs. not white

## Race vs Education (Jean)

We want to look at the relationship between one's race and education degree. 

```{r t_test_for_race_education}

ask_a_manager_2021_race <- ask_a_manager_2021 %>% 
  mutate(if_white = if_else(race == "White", "Yes", "No"),
         high_school = if_else(highest_level_of_education_completed == "High School", "Yes", "No")) %>% 
  select(if_white,high_school)

ask_a_manager_2021_race

prop.test(~if_white, data = ask_a_manager_2021_race, success = "Yes")


```


## Changed Industry? vs salary (Raghav)



```{r}
colnames(ask_a_manager_2021)
```



# Regression Analysis (Yuan)

