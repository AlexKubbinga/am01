---
title: "Ask A Manager 2021"
author: "Group 5 MAM"
date: "2021-09-16"
output: html_document
---

```{r load-libraries, echo=FALSE, warning=FALSE}
library(tidyverse)
library(janitor) 
library(skimr)
library(countrycode) # to clean up country names
library(broom)
library(car)
library(ggfortify)
library(mosaic)
library(dplyr)
library(huxtable)
library(tidyquant)

```


```{r}
# load "Ask a A Manager 2021 Survey" googlesheet
# https://www.askamanager.org/
ask_a_manager_2021 <- read_csv(here::here("data","ask_a_manager.csv"))

skimr::skim(ask_a_manager_2021)

```

# Data cleaning (exchange rate: Alex)

remove missing values.

```{r remove-na}
# remove the NA values
ask_a_manager_2021 <- ask_a_manager_2021 %>% 
  filter(!gender %in% c("NA","Other or prefer not to answer","Prefer not to answer", "Non-binary", NA) &
           race!="NA" &
           highest_level_of_education_completed!="NA")
```

remove outliers

```{r remove-outliers-z-score}
# using z-score. remove data out of 3 sigma
ask_a_manager_2021 <- ask_a_manager_2021[-which(abs(scale(ask_a_manager_2021$annual_salary))>3),]

```

```{r}
# using quantile. remove data larger than 75%+1.5*IQR or smaller than 25%-1.5*IQR
# Q <- quantile(ask_a_manager_2021$salary, probs=c(.25, .75))
# iqr <- IQR(ask_a_manager_2021$salary)
# up <-  Q[2]+1.5*iqr # Upper Range  
# up <-  Q[1]-1.5*iqr # Upper Range  
# ask_a_manager_2021 <- ask_a_manager_2021 %>% 
#   filter(salary>=low & salary<=up)
```


transform into ordered `factor` datatype

```{r, warning=FALSE}
ask_a_manager_2021 <- ask_a_manager_2021 %>% 
  mutate(
    country = countrycode::countryname(country),
    age_group = factor(how_old_are_you,levels=c("under 18","18-24","25-34","35-44","45-54","55-64","65 or over")),
    field_exp = factor(years_of_experience_in_field,levels=c("1 year or less","2 - 4 years","5-7 years","8 - 10 years","11 - 20 years","21 - 30 years","31 - 40 years","41 years or more")),
    pro_exp = factor(overall_years_of_professional_experience,levels=c("1 year or less","2 - 4 years","5-7 years","8 - 10 years","11 - 20 years","21 - 30 years","31 - 40 years","41 years or more")),
    education = factor(highest_level_of_education_completed, labels=c("High School","Some college","College degree","Master's degree","PhD","Professional degree")),
    salary = annual_salary,
    log_salary = log(annual_salary)
  ) %>% 
  janitor::clean_names() # clean columns names
```

only keep the names of top 25 industries.

```{r}
# Industry is messy... it has > 1000 different industries.
# we only keep the names of top 25 industries. (24597(92%) out of 26765 entries)
industry_list <- ask_a_manager_2021 %>% 
  count(industry, sort=TRUE) %>% 
  mutate(percent = 100* n/sum(n)) %>% 
  slice_max(order_by = n, n = 25) %>% 
  select(industry)
ask_a_manager_2021 <- ask_a_manager_2021 %>% 
  mutate(industry = ifelse(industry %in% industry_list$industry,
                           industry,
                           "Others"))

```

only keep the commonly used currencies and standardize the number
```{r}
av_api_key("DLTJZL3OWXJP607Q")
tiingo_api_key('<your-api-key>')
tq_get_options()
tq_get("USD/EUR", get = "tiingo", from="2021-01-01", to="2021-01-15")
#
tq_get("USD/EUR", get = "alphavantage", av_fun = "FX_DAILY", from_symbol="EUR")

ask_a_manager_2021 %>% 
  count(currency, sort=TRUE) %>% 
  mutate(percent = 100* n/sum(n))
```

```{r}
# transform all the currencies into USD and only keep the commonly used currencies
# todo (Alex)


ask_a_manager_2021 <- ask_a_manager_2021 %>% 
  filter(currency=="USD" &
           !is.na(country))

# filter out outliers of annual salary
# regression for both datasets
# ask_a_manager_2021 <- ask_a_manager_2021 %>% 
#   filter(salary>1000 & salary<1000000)
# todo

```

# Exploratory Data Analysis

## Counts

```{r, fig.width=3}
# Some quick counts, groups, etc
ask_a_manager_2021 %>% 
  count(age_group, sort=TRUE) %>% 
  mutate(percent = 100* n/sum(n)) %>% 
  ggplot(aes(x=fct_reorder(age_group,-n), y=n)) +
  geom_bar(stat="identity") + labs(title = "Age distribution of Ask a Manager survey respondents",                                                 x="Age group",
                  y="Frequency",                                                  caption = "Source:Askamanager.com")



# 'country' 
ask_a_manager_2021 %>%
  count(country, sort=TRUE) %>% 
  mutate(percent = 100* n/sum(n))

# 'city' 
ask_a_manager_2021 %>% 
  count(city, sort=TRUE) %>% 
  mutate(percent = 100* n/sum(n))

# education 
ask_a_manager_2021 %>% 
  count(education) %>% 
  mutate(percent = 100* n/sum(n))%>% 
  arrange(desc(percent))

# gender
ask_a_manager_2021 %>% 
  count(gender) %>% 
  mutate(percent = 100* n/sum(n))%>% 
  arrange(desc(percent))

# race
ask_a_manager_2021 %>% 
  count(race) %>% 
  mutate(percent = 100* n/sum(n))%>% 
  arrange(desc(percent))

# pro_exp 
ask_a_manager_2021 %>% 
  count(pro_exp ) %>% 
  mutate(percent = 100* n/sum(n))%>% 
  arrange(desc(percent))

# field_exp  
ask_a_manager_2021 %>% 
  count(field_exp  ) %>% 
  mutate(percent = 100* n/sum(n))%>% 
  arrange(desc(percent))

```

## Salary (Yuan)

How is salary distributed?

```{r}

favstats(ask_a_manager_2021$salary) # find a really rich guy here


# density
g1 <- ggplot(ask_a_manager_2021, aes(x=salary))+
  geom_density()+
  NULL
#cdf
g2 <- ask_a_manager_2021 %>% 
  slice_min(order_by = salary,n =nrow(ask_a_manager_2021)-5) %>% # choose a number
  ggplot(aes(x=salary))+
  stat_ecdf()+
  NULL

# taking log is better
g3 <- ggplot(ask_a_manager_2021, aes(x=log(salary)))+
  geom_density()+
  NULL

g4 <- ask_a_manager_2021 %>% 
  slice_min(order_by = salary,n =nrow(ask_a_manager_2021)-5) %>% # choose a number
  ggplot(aes(x=log(salary)))+
  stat_ecdf()+
  NULL

gridExtra::grid.arrange(g1,g2,g3,g4)
```

right skewed distribution. 

## Industry (Yuan)

```{r}
ask_a_manager_2021 %>% 
  count(industry, sort=TRUE) %>% 
  ggplot(aes(y=fct_reorder(industry,n), x=n))+
  geom_col()
```

## Gender vs Industry (Yuan)

```{r, fig.height= = 20}
# salary gap
ask_a_manager_2021 %>% 
  group_by(industry, gender) %>% 
  summarise(count = n(),
            avg_salary = mean(salary)) %>% 
  ggplot(aes(y=fct_reorder(industry,avg_salary), x=avg_salary,fill=gender))+
  geom_bar(position="dodge", stat="identity")+
  scale_fill_manual(breaks = c("Man","Woman"),
                    values = c("sky blue", "pink"))+
  labs(
    title="",
    x="",
    y=""
  )+
  NULL
```



```{r}
# salary gap
ask_a_manager_2021 %>% 
  group_by(industry, gender) %>% 
  summarise(count = n(),
            avg_salary = mean(salary)) %>% 
  pivot_wider(id_cols = 1:4,
              names_from = gender,
              values_from = count:avg_salary) %>% 
  mutate(size = count_Man+count_Woman,
         male_prop = count_Man/(count_Man+count_Woman),
         salary_gap = avg_salary_Man - avg_salary_Woman) %>% 
  ggplot(aes(y=fct_reorder(industry,salary_gap), x=salary_gap,fill=male_prop))+
  geom_col()+
  geom_point(aes(y=fct_reorder(industry,size),x=size*10))+
  scale_x_continuous(
    # Features of the first axis
    name = "Annual Salary (barplot)",
    # Add a second axis and specify its features
    sec.axis = sec_axis(trans = ~., name="Sample size (point)")
  ) +
  scale_fill_gradient(low="pink", high="sky blue")+
  labs(
    title="",
    x="",
    y=""
  )+
  NULL


```

## Education (Jean)

```{r Education_salary, warning=FALSE, echo=FALSE}

ask_a_manager_2021 %>% 
  filter(gender %in% c("Man", "Woman")) %>% 
  mutate(sex = factor (gender, labels = c("Man", "Woman"))) %>% 
  rename(Education = education) %>% 
  group_by(Education, gender) %>% 
  summarise (median_salary_by_edu = median (salary),
             mean_salary_by_edu = mean(salary)) %>% 
  ggplot () +
  geom_col(aes (Education, median_salary_by_edu, fill = gender), position = position_dodge(width = 0.9), alpha = 0.7)+
  geom_point(aes(x = Education, y=mean_salary_by_edu, color = gender))+
  theme_bw()+
  NULL


```


## Race (Clara)
```{r}
ask_a_manager_2021 %>% 
  group_by(race) %>% 
  filter(n() > 500) %>% 
  summarise(count=n()) %>% 
  ggplot(aes(y=count, x=race, fill=race))+
  geom_col() +
  theme(legend.position = "none") +
  labs(x="Race", y="Count", title="Count by Race", subtitle = "Races with > 500 Respondents")+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) + 
  NULL
```

### Race and Mean Salary 

```{r}
ask_a_manager_2021 %>% 
  group_by(race) %>% 
  filter(n() > 500) %>% 
  summarise(annual_average_delta = mean(delta, na.rm=TRUE)) %>% 
  ggplot(aes(y=mean, x=race, color=race))+
  geom_col() +
  theme(legend.position = "none") +
  labs(x="Race", y="Count", title="Count by Race", subtitle = "Races with > 500 Respondents")+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) + 
  NULL
```


## Location (Alex)
```{r, }
#This package is useful for creating a map of the USA
library(usmap)
library(ggrepel)

#create df of the list of states with >10 occurrences 
#This allows us to get data for actual states as many data entry errors
#many individuals put multiple states and this helps to fix that
states <- ask_a_manager_2021 %>% 
  group_by(state) %>%
  filter(!is.na(state)) %>%
  filter(n()>10) %>% 
  summarise(mean_salary = mean(salary),
            count_state = count(state))

states$fips <- fips(states$state)
statesalarymap <- states %>% select(state,mean_salary)

plot_usmap(data=statesalarymap, values="mean_salary", color="red") + scale_fill_continuous(
    low = "white",
    high = "red",
    name = "Mean Salary") +
  theme(legend.position = "right") +
  labs(title="Map of US States based on Average Salary")


```

> MAP

```{r}
# Count by Industry

ask_a_manager_2021 %>% 
  group_by(industry) %>% 
  summarise(count=n()) %>% 
  ggplot(aes(y=fct_reorder(industry,count),x=count))+
  geom_col()

# null hypothesis: no difference between
```

## Age (Raina)


## Experience (Raghav)


# Statistical Tests


## Gender vs Salary (Clara)

```{r}
ask_a_manager_2021 %>% 
  ggplot(aes(x=gender,y=log_salary))+
  geom_boxplot()
```

```{r}
ask_a_manager_2021 <- ask_a_manager_2021 %>%
  filter(gender!="Non-binary")
t.test(salary ~ gender, data = ask_a_manager_2021)
```



## Gender vs Education (Jean)

We want to look at the relationship between one's gender and education degree. 

```{r t_test_for_gender_education}

ask_a_manager_2021 <- ask_a_manager_2021 %>% 
  mutate(high_school = if_else(education == "High School", "Yes", "No")) %>% 
  select(gender,high_school)
  # group_by(gender) %>% 
  # summarise(n=sum(high_school == "Yes"))
  # group_by (gender) %>%
  # summarise (highschool_degree = sum(education == "High School", na.rm = TRUE)/n())

ask_a_manager_2021

prop.test(~gender , data = ask_a_manager_2021, success = "Yes")


```


## Race vs Salary (Raina)

> wisely choose the race. like white vs. not white

## Race vs Education (Jean)

We want to look at the relationship between one's race and education degree. 

```{r t_test_for_race_education}

ask_a_manager_2021 <- ask_a_manager_2021 %>% 
  mutate(if_white = if_else(race == "White", "Yes", "No")) %>% 
  select(if_white,high_school)

ask_a_manager_2021

prop.test(~if_white, data = ask_a_manager_2021, success = "Yes")


```


## Changed Industry? vs salary (Raghav)



# Regression Analysis (Yuan)

```{r}
reg_data <- ask_a_manager_2021 %>% 
  mutate(country = ifelse(country=="US","US","Non-US"))
m1 <- lm(salary ~ education, data=reg_data)
m2 <- lm(salary ~ education+age_group, data=reg_data)
m3 <- lm(salary ~ education+gender, data=reg_data)
m4 <- lm(salary ~ education+gender+country, data=reg_data)


huxreg(m1, m2, m3, m4,
       statistics = c('#observations' = 'nobs', 
                      'R squared' = 'r.squared', 
                      'Adj. R Squared' = 'adj.r.squared', 
                      'Residual SE' = 'sigma'), 
       bold_signif = 0.05, 
       stars = NULL
) %>% 
  set_caption('Comparison of models')

```


