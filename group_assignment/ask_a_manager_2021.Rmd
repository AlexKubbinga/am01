---
title: "Ask A Manager 2021"
author: "Group 5 MAM"
date: "2021-09-16"
output: html_document
---

```{r load-libraries, echo=FALSE, warning=FALSE}
library(tidyverse)
library(janitor) 
library(skimr)
library(countrycode) # to clean up country names
library(broom)
library(car)
library(ggfortify)
library(mosaic)
library(dplyr)

```


```{r}
# load "Ask a A Manager 2021 Survey" googlesheet
# https://www.askamanager.org/
ask_a_manager_2021 <- read_csv(here::here("data","ask_a_manager.csv"))

skimr::skim(ask_a_manager_2021)

```

# Data cleaning (exchange rate: Alex)

remove missing values.

```{r remove-na}
# remove the NA values
ask_a_manager_2021 <- ask_a_manager_2021 %>% 
  filter(!gender %in% c("NA","Other or prefer not to answer","Prefer not to answer", "Non-binary", NA) &
           race!="NA" &
           highest_level_of_education_completed!="NA")
```

remove outliers

```{r remove-outliers-z-score}
# using z-score. remove data out of 3 sigma
ask_a_manager_2021 <- ask_a_manager_2021[-which(abs(scale(ask_a_manager_2021$annual_salary))>3),]

```

```{r}
# using quantile. remove data larger than 75%+1.5*IQR or smaller than 25%-1.5*IQR
Q <- quantile(ask_a_manager_2021$annual_salary, probs=c(.25, .75))
iqr <- IQR(ask_a_manager_2021$annual_salary)
up <-  Q[2]+1.5*iqr # Upper Range  
ask_a_manager_2021 <- ask_a_manager_2021 %>% 
  filter(annual_salary>=low & annual_salary<=up)
```



transform into ordered `factor` datatype

```{r, warning=FALSE}
ask_a_manager_2021 <- ask_a_manager_2021 %>% 
  mutate(
    country = countrycode::countryname(country),
    how_old_are_you = factor(how_old_are_you,levels=c("under 18","18-24","25-34","35-44","45-54","55-64","65 or over")),
    years_of_experience_in_field = factor(years_of_experience_in_field,levels=c("1 year or less","2 - 4 years","5-7 years","8 - 10 years","11 - 20 years","21 - 30 years","31 - 40 years","41 years or more")),
    overall_years_of_professional_experience = factor(overall_years_of_professional_experience,levels=c("1 year or less","2 - 4 years","5-7 years","8 - 10 years","11 - 20 years","21 - 30 years","31 - 40 years","41 years or more")),
    highest_level_of_education_completed = factor(highest_level_of_education_completed, labels=c("High School","Some college","College degree","Master's degree","PhD","Professional degree")),
    log_annual_salary = log(annual_salary)
  ) %>% 
  janitor::clean_names() # clean columns names
```

only keep the names of top 25 industries.

```{r}
# Industry is messy... it has > 1000 different industries.
# we only keep the names of top 25 industries. (24597(92%) out of 26765 entries)
industry_list <- ask_a_manager_2021 %>% 
  count(industry, sort=TRUE) %>% 
  mutate(percent = 100* n/sum(n)) %>% 
  slice_max(order_by = n, n = 25) %>% 
  select(industry)
ask_a_manager_2021 <- ask_a_manager_2021 %>% 
  mutate(industry = ifelse(industry %in% industry_list$industry,
                           industry,
                           "Others"))

```

only keep the commonly used currencies and standardize the number

```{r}
# transform all the currencies into USD and only keep the commonly used currencies
# todo (Alex)
ask_a_manager_2021 <- ask_a_manager_2021 %>% 
  filter(industry %in% industry_list$industry &
           currency=="USD" &
           !is.na(country))

# filter out outliers of annual salary
# regression for both datasets
# ask_a_manager_2021 <- ask_a_manager_2021 %>% 
#   filter(annual_salary>1000 & annual_salary<1000000)
# todo

```

# Exploratory Data Analysis

## Counts

```{r}
# Some quick counts, groups, etc
ask_a_manager_2021 %>% 
  count(how_old_are_you, sort=TRUE) %>% 
  mutate(percent = 100* n/sum(n))

# 'country' 
ask_a_manager_2021 %>% 
  count(country, sort=TRUE) %>% 
  mutate(percent = 100* n/sum(n))

# 'city' 
ask_a_manager_2021 %>% 
  count(city, sort=TRUE) %>% 
  mutate(percent = 100* n/sum(n))

# highest_level_of_education_completed 
ask_a_manager_2021 %>% 
  count(highest_level_of_education_completed) %>% 
  mutate(percent = 100* n/sum(n))%>% 
  arrange(desc(percent))

# gender
ask_a_manager_2021 %>% 
  count(gender) %>% 
  mutate(percent = 100* n/sum(n))%>% 
  arrange(desc(percent))

# race
ask_a_manager_2021 %>% 
  count(race) %>% 
  mutate(percent = 100* n/sum(n))%>% 
  arrange(desc(percent))

# overall_years_of_professional_experience 
ask_a_manager_2021 %>% 
  count(overall_years_of_professional_experience ) %>% 
  mutate(percent = 100* n/sum(n))%>% 
  arrange(desc(percent))

# years_of_experience_in_field  
ask_a_manager_2021 %>% 
  count(years_of_experience_in_field  ) %>% 
  mutate(percent = 100* n/sum(n))%>% 
  arrange(desc(percent))

```

## Salary (Yuan)

How is salary distributed?

```{r}

favstats(ask_a_manager_2021$annual_salary) # find a really rich guy here


# density
g1<-ggplot(ask_a_manager_2021, aes(x=annual_salary))+
  geom_density()+
  NULL
#cdf
g2<-ask_a_manager_2021 %>% 
  slice_min(order_by = annual_salary,n =nrow(ask_a_manager_2021)-5) %>% # choose a number
  ggplot(aes(x=annual_salary))+
  stat_ecdf()+
  NULL

# taking log is better
g3<-ggplot(ask_a_manager_2021, aes(x=log(annual_salary)))+
  geom_density()+
  NULL

g4<-ask_a_manager_2021 %>% 
  slice_min(order_by = annual_salary,n =nrow(ask_a_manager_2021)-5) %>% # choose a number
  ggplot(aes(x=log(annual_salary)))+
  stat_ecdf()+
  NULL

gridExtra::grid.arrange(g1,g2,g3,g4)
```

right skewed distribution. 

## Industry (Yuan)

```{r}
ask_a_manager_2021 %>% 
  count(industry, sort=TRUE) %>% 
  ggplot(aes(y=fct_reorder(industry,n), x=n))+
  geom_col()
```

## Gender vs Industry (Yuan)

```{r}
ask_a_manager_2021 %>% 
  group_by(industry, gender) %>% 
  summarise(count = n(),
            avg_salary = mean(annual_salary)) %>% 
  pivot_wider(id_cols = 1:4,
              names_from = gender,
              values_from = count:avg_salary) %>% 
  mutate(size = count_Man+count_Woman,
         male_prop = count_Man/(count_Man+count_Woman),
         salary_gap = avg_salary_Man - avg_salary_Woman) %>% 
  ggplot(aes(y=fct_reorder(industry,salary_gap), x=salary_gap,fill=male_prop))+
  geom_col()+
  geom_point(aes(y=fct_reorder(industry,size),x=size*10))+
  scale_x_continuous(
    # Features of the first axis
    name = "Annual Salary",
    # Add a second axis and specify its features
    sec.axis = sec_axis(trans = ~., name="Sample size")
  ) +
  scale_fill_gradient(low="pink", high="sky blue")+
  labs(
    title="",
    x="",
    y=""
  )+
  NULL
```

## Education (Jean)

We want to visually explore the relationship between one's education level and one's salary from the sample. In the below graph, the colored bars indicate the median salary for man and woman from the sample data, while the colored dots shows the average salary for both group. 

We can see that for both gender group, the mean salary is higher than the median salary, reflecting the fact that there are a number of outliers in our sample data with extremely high salary reported.

```{r Education_salary, warning=FALSE, echo=FALSE}

ask_a_manager_2021 %>% 
  filter(gender %in% c("Man", "Woman")) %>% 
  mutate(sex = factor (gender, labels = c("Man", "Woman"))) %>% 
  rename(Education = highest_level_of_education_completed) %>% 
  group_by(Education, gender) %>% 
  summarise (median_salary_by_edu = median (annual_salary),
             mean_salary_by_edu = mean(annual_salary)) %>% 
  ggplot () +
  geom_col(aes (Education, median_salary_by_edu, fill = gender), position = position_dodge(width = 0.9), alpha = 0.7)+
  geom_point(aes(x = Education, y=mean_salary_by_edu, color = gender))+
  theme_bw()+
  NULL


```


## Race (Clara)
```{r}
ask_a_manager_2021 %>% 
  group_by(race) %>% 
  filter(n() > 500) %>% 
  summarise(count=n()) %>% 
  ggplot(aes(y=count, x=race, fill=race))+
  geom_col() +
  theme(legend.position = "none") +
  labs(x="Race", y="Count", title="Count by Race", subtitle = "Races with > 500 Respondents")+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) + 
  NULL
```

### Race and Mean Salary 
```{r}
ask_a_manager_2021 %>% 
  group_by(race) %>% 
  filter(n() > 500) %>% 
  summarise(annual_average_delta = mean(delta, na.rm=TRUE)) %>% 
  ggplot(aes(y=mean, x=race, color=race))+
  geom_col() +
  theme(legend.position = "none") +
  labs(x="Race", y="Count", title="Count by Race", subtitle = "Races with > 500 Respondents")+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) + 
  NULL
```


## Location (Alex)

> MAP

```{r}
# Count by Industry

ask_a_manager_2021 %>% 
  group_by(industry) %>% 
  summarise(count=n()) %>% 
  ggplot(aes(y=fct_reorder(industry,count),x=count))+
  geom_col()

# null hypothesis: no difference between
```

## Age (Raina)


## Experience (Raghav)


# Statistical Tests


## Gender vs Salary (Clara)

```{r}
ask_a_manager_2021 %>% 
  ggplot(aes(x=gender,y=log_annual_salary))+
  geom_boxplot()
```

```{r}
ask_a_manager_2021 <- ask_a_manager_2021 %>%
  filter(gender!="Non-binary")
t.test(annual_salary ~ gender, data = ask_a_manager_2021)
```



## Gender vs Education (Jean)

We want to look at the relationship between one's gender and education degree. In essence, we want to explore if there is a difference in the proportion of respondants with high school degree as their highest degree for male group and the female group. We can use the proportion test to generate the result from the male and female sample.

```{r prop_test_for_gender_education_college}

ask_a_manager_2021_education <- ask_a_manager_2021 %>% 
  filter(gender !="Non-binary") %>%
  mutate(high_school = if_else(highest_level_of_education_completed == "High School", "Yes", "No")) %>% 
  group_by(gender) %>% 
  summarise(college_below=sum(high_school == "Yes"), college_or_above = sum(high_school == "No"))

ask_a_manager_2021_education

prop.test(x = c(1710,8147), n = c(1872+1710,7585+8147), alternative = "two.sided")

```

From the result of proportion test for male group and female group, we are 99% confident that the proportion of high school as highest education level for male is higher than that for female, indicating that overall female has a higher college-entry rate vs. the male.

If we repeat the process to explore the difference in proportion in acquiring a masters or above degree for both gender:

```{r prop_test_for_gender_education_master}

ask_a_manager_2021_education <- ask_a_manager_2021 %>% 
  filter(gender !="Non-binary") %>%
  mutate(higher_edu = if_else(highest_level_of_education_completed %in% c("Master's degree", "Professional degree", "Phd"), "Yes", "No")) %>% 
  group_by(gender) %>% 
  summarise(master_or_above=sum(higher_edu == "Yes"), master_below = sum(higher_edu == "No"))

ask_a_manager_2021_education

prop.test(x = c(519,1667), n = c(519+3063,1667+14065), alternative = "two.sided")

```

From the result of two proportion tests, we can see that even though the proportion of acquiring a college-or-above degree is less in the male group, the proportion of acquiring higher education degree (Master's-or-above) is higher than the female group. This somehow explains the fact that there are more outliers in male sample with extremely high income level.

## Race vs Salary (Raina)

> wisely choose the race. like white vs. not white

## Race vs Education (Jean)

We want to look at the relationship between one's race and education degree. Particularly, we want to see if there is a difference in education level for those being white and those being non-white.

As the above analysis for gender vs. education, we run two proportion tests for college-or-above degree percentage and master-or-above percentage between the male and female group.

```{r prop_test_for_race_education_college}

ask_a_manager_2021_race <- ask_a_manager_2021 %>% 
  mutate(if_white = if_else(race == "White", "White", "Non-white"),
         high_school = if_else(highest_level_of_education_completed == "High School", "Yes", "No")) %>% 
  group_by(if_white) %>% 
  summarise(college_below=sum(high_school == "Yes"), college_or_above = sum(high_school == "No"))

ask_a_manager_2021_race

prop.test(x = c(1467,8390), n = c(1467+1613,8390+7844), alternative = "two.sided")

```
From the result of proportion test for white group and non-white group, we are 99% confident that the proportion of high school as highest education level for the white is higher than that for those of other races, indicating that overall white people has a higher college-entry rate than others.

Similarly, if we run the test for the propotion of master_or_above education level between white and non-white races:

```{r prop_test_for_race_education_master}

ask_a_manager_2021_race <- ask_a_manager_2021 %>% 
  mutate(if_white = if_else(race == "White", "White", "Non-white"),
         higher_edu = if_else(highest_level_of_education_completed %in% c("Master's degree", "Professional degree", "Phd"), "Yes", "No")) %>% 
  group_by(if_white) %>% 
  summarise(master_or_above=sum(higher_edu == "Yes"), master_below = sum(higher_edu == "No"))

ask_a_manager_2021_race

prop.test(x = c(322,1864), n = c(322+2758,1864+14370), alternative = "two.sided")

```
From the result of the proportion test, we cannot see a clear difference between the proportion of acquiring a higher education level (masters or above) in white and non-white group, as the p-value is higher than 5%.

## Changed Industry? vs salary (Raghav)



```{r}
colnames(ask_a_manager_2021)
```



# Regression Analysis (Yuan)

```{r}

m1 <- lm(annual_salary ~ highest_level_of_education_completed, data=ask_a_manager_2021)
m2 <- lm(annual_salary ~ highest_level_of_education_completed+how_old_are_you, data=ask_a_manager_2021)
m3 <- lm(annual_salary ~ highest_level_of_education_completed+gender, data=ask_a_manager_2021)
m4 <- lm(annual_salary ~ highest_level_of_education_completed+gender+race, data=ask_a_manager_2021)


huxreg(m1, m2, m3, m4,
       leave_politics, leave_everything,final_model,
       statistics = c('#observations' = 'nobs', 
                      'R squared' = 'r.squared', 
                      'Adj. R Squared' = 'adj.r.squared', 
                      'Residual SE' = 'sigma'), 
       bold_signif = 0.05, 
       stars = NULL
) %>% 
  set_caption('Comparison of models')

```


