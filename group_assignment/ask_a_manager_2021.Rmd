---
title: "Ask A Manager 2021"
author: "Group 5 MAM"
date: "2021-09-16"
output: html_document
---

```{r load-libraries, echo=FALSE, warning=FALSE}
library(tidyverse)
library(janitor) 
library(skimr)
library(countrycode) # to clean up country names
library(broom)
library(car)
library(ggfortify)
library(mosaic)
library(dplyr)
library(huxtable)
library(ggthemes)
library(tidyquant)

```


```{r}
# load "Ask a A Manager 2021 Survey" googlesheet
# https://www.askamanager.org/
ask_a_manager_2021 <- read_csv(here::here("data","ask_a_manager.csv"))

skimr::skim(ask_a_manager_2021)

```

# Data cleaning (exchange rate: Alex)

remove missing values.

```{r remove-na}
# remove the NA values
ask_a_manager_2021 <- ask_a_manager_2021 %>% 
  filter(!gender %in% c("NA","Other or prefer not to answer","Prefer not to answer", "Non-binary", NA) &
           race!="NA" &
           highest_level_of_education_completed!="NA")
```

remove outliers

```{r remove-outliers-z-score}
# using z-score. remove data out of 3 sigma
ask_a_manager_2021 <- ask_a_manager_2021[-which(abs(scale(ask_a_manager_2021$annual_salary))>3),]

```

```{r}
# using quantile. remove data larger than 75%+1.5*IQR or smaller than 25%-1.5*IQR
# Q <- quantile(ask_a_manager_2021$salary, probs=c(.25, .75))
# iqr <- IQR(ask_a_manager_2021$salary)
# up <-  Q[2]+1.5*iqr # Upper Range  
# up <-  Q[1]-1.5*iqr # Upper Range  
# ask_a_manager_2021 <- ask_a_manager_2021 %>% 
#   filter(salary>=low & salary<=up)
```


transform into ordered `factor` datatype

```{r, warning=FALSE}
ask_a_manager_2021 <- ask_a_manager_2021 %>% 
  mutate(
    country = countrycode::countryname(country),
    age_group = factor(how_old_are_you,levels=c("under 18","18-24","25-34","35-44","45-54","55-64","65 or over")),
    field_exp = factor(years_of_experience_in_field,levels=c("1 year or less","2 - 4 years","5-7 years","8 - 10 years","11 - 20 years","21 - 30 years","31 - 40 years","41 years or more")),
    pro_exp = factor(overall_years_of_professional_experience,levels=c("1 year or less","2 - 4 years","5-7 years","8 - 10 years","11 - 20 years","21 - 30 years","31 - 40 years","41 years or more")),
    education = factor(highest_level_of_education_completed, labels=c("High School","Some college","College degree","Master's degree","Professional degree", "PhD")),
    higher_edu = ifelse(education %in% c("College degree","Master's degree", "PhD", "Professional degree"),1,0),
    salary = annual_salary,
    log_salary = log(annual_salary)
  ) %>% 
  janitor::clean_names() # clean columns names
```

only keep the names of top 25 industries.

```{r}
# Industry is messy... it has > 1000 different industries.
# we only keep the names of top 25 industries. (24597(92%) out of 26765 entries)
industry_list <- ask_a_manager_2021 %>% 
  count(industry, sort=TRUE) %>% 
  mutate(percent = 100* n/sum(n)) %>% 
  slice_max(order_by = n, n = 25) %>% 
  select(industry)
ask_a_manager_2021 <- ask_a_manager_2021 %>% 
  mutate(industry = ifelse(industry %in% industry_list$industry,
                           industry,
                           "Others"))

```

only keep the commonly used currencies and standardize the number
```{r}
library(quantmod)

# ask_a_manager_2021 %>%
#   count(currency, sort=TRUE) %>% 
#   mutate(percent = 100* n/sum(n))

#We can see that USD, CAD, GBP, EUR, (AUD/NZD) are the most common currencies
# We will convert the currencies all to USD using exchange rate data from quantmod
# The currency rate will be taken from the last date of the survey "2021-09-14"

currencies <-getSymbols(c("EUR/USD","CAD/USD","GBP/USD","AUD/USD"),
                        from="2021-09-14", to="2021-09-14", src="oanda")

# GB<- ask_a_manager_2021 %>% filter(currency=="GBP")
# 
# for (row in 1:length(ask_a_manager_2021$currency)) {
#   if(curr=="GBP") {
#     ask_a_manager_2021[row,6] <- ask_a_manager_2021[row,6]*first(GBPUSD)
#     print("tea?")
#   }
# }

```

```{r}
# transform all the currencies into USD and only keep the commonly used currencies
# todo (Alex)


ask_a_manager_2021 <- ask_a_manager_2021 %>% 
  filter(currency=="USD" &
           !is.na(country))

# filter out outliers of annual salary
# regression for both datasets
# ask_a_manager_2021 <- ask_a_manager_2021 %>% 
#   filter(salary>1000 & salary<1000000)
# todo

```

# Exploratory Data Analysis

## Counts

```{r, fig.width=3}
# Some quick counts, groups, etc
ask_a_manager_2021 %>% 
  count(age_group, sort=TRUE) %>% 
  mutate(percent = 100* n/sum(n)) %>% 
  ggplot(aes(x=fct_reorder(age_group,-n), y=n)) +
  geom_bar(stat="identity") + labs(title = "Age distribution of Ask a Manager survey respondents",                                                 x="Age group",
                  y="Frequency",                                                  caption = "Source:Askamanager.com")



# 'country' 
ask_a_manager_2021 %>%
  count(country, sort=TRUE) %>% 
  mutate(percent = 100* n/sum(n))

# 'city' 
ask_a_manager_2021 %>% 
  count(city, sort=TRUE) %>% 
  mutate(percent = 100* n/sum(n))

# education 
ask_a_manager_2021 %>% 
  count(education) %>% 
  mutate(percent = 100* n/sum(n))%>% 
  arrange(desc(percent))

# gender
ask_a_manager_2021 %>% 
  count(gender) %>% 
  mutate(percent = 100* n/sum(n))%>% 
  arrange(desc(percent))

# race
ask_a_manager_2021 %>% 
  count(race) %>% 
  mutate(percent = 100* n/sum(n))%>% 
  arrange(desc(percent))

# pro_exp 
ask_a_manager_2021 %>% 
  count(pro_exp ) %>% 
  mutate(percent = 100* n/sum(n))%>% 
  arrange(desc(percent))

# field_exp  
ask_a_manager_2021 %>% 
  count(field_exp  ) %>% 
  mutate(percent = 100* n/sum(n))%>% 
  arrange(desc(percent))

```

## Salary (Yuan)

How is salary distributed?

```{r}

favstats(ask_a_manager_2021$salary) # find a really rich guy here


# density
g1 <- ggplot(ask_a_manager_2021, aes(x=salary))+
  geom_density()+
  NULL
#cdf
g2 <- ask_a_manager_2021 %>% 
  slice_min(order_by = salary,n =nrow(ask_a_manager_2021)-5) %>% # choose a number
  ggplot(aes(x=salary))+
  stat_ecdf()+
  NULL

# taking log is better
g3 <- ggplot(ask_a_manager_2021, aes(x=log(salary)))+
  geom_density()+
  NULL

g4 <- ask_a_manager_2021 %>% 
  slice_min(order_by = salary,n =nrow(ask_a_manager_2021)-5) %>% # choose a number
  ggplot(aes(x=log(salary)))+
  stat_ecdf()+
  NULL

gridExtra::grid.arrange(g1,g2,g3,g4)
```

Observation: This is a right skewed distribution. 

## Industry(Yuan)

```{r}
ask_a_manager_2021 %>% 
  count(industry, sort=TRUE) %>% 
  ggplot(aes(y=fct_reorder(industry,n), x=n))+
  geom_col()
```

## Salary ,Gender and Industry (Yuan)

```{r, fig.width=5}
# Industries of top average salary for Man and Woman
salary_table <- ask_a_manager_2021 %>% 
  group_by(industry, gender) %>% 
  summarise(count = n(),
            avg_salary = mean(salary),
            higher_edu_prop = sum(higher_edu)/n()) %>% 
  pivot_wider(id_cols = 1:5,
              names_from = gender,
              values_from = count:higher_edu_prop)
  

g_man <- salary_table %>% 
  ggplot()+
  geom_bar(aes(y=fct_reorder(industry,avg_salary_Man), x=avg_salary_Man,fill=higher_edu_prop_Man), position="dodge", stat="identity")+
  scale_fill_gradient(low="sky blue", high="blue")+
  labs(
    title="Man",
    x="Annual Salary $",
    y="Industry"
  )+
  theme_wsj()+
  theme(legend.position="bottom")+
  NULL

g_woman <- salary_table %>% 
  ggplot()+
  geom_bar(aes(y=fct_reorder(industry,avg_salary_Woman), x=avg_salary_Woman,fill=higher_edu_prop_Woman), position="dodge", stat="identity")+
  scale_fill_gradient(low="pink", high="red")+
  labs(
    title="Woman",
    x="Annual Salary $",
    y="Industry"
  )+
  theme_wsj()+
  theme(legend.position="bottom")+
  NULL

gridExtra::grid.arrange(g_man, g_woman, nrow=1)
```



```{r}
# salary gap in different industries
ask_a_manager_2021 %>% 
  group_by(industry, gender) %>% 
  summarise(count = n(),
            avg_salary = mean(salary)) %>% 
  pivot_wider(id_cols = 1:4,
              names_from = gender,
              values_from = count:avg_salary) %>% 
  mutate(size = count_Man+count_Woman,
         male_prop = count_Man/(count_Man+count_Woman),
         salary_gap = avg_salary_Man - avg_salary_Woman) %>% 
  ggplot(aes(y=fct_reorder(industry,salary_gap), x=salary_gap,fill=male_prop))+
  geom_col()+
  
  # geom_point(aes(y=fct_reorder(industry,size),x=size*10))+
  
  scale_x_continuous(
    breaks = seq(-20000,40000,5000)
  ) +
  scale_fill_gradient(low="pink", high="sky blue")+
  labs(
    title="TITLE",
    x="Salary Gap in $",
    y=""
  )+
  theme_wsj()+
  theme(legend.position="bottom")+
  NULL


```

## Education (Jean)

```{r Education_salary, warning=FALSE, echo=FALSE}

ask_a_manager_2021 %>% 
  filter(gender %in% c("Man", "Woman")) %>% 
  mutate(sex = factor (gender, labels = c("Man", "Woman"))) %>% 
  rename(Education = education) %>% 
  group_by(Education, gender) %>% 
  summarise (median_salary_by_edu = median (salary),
             mean_salary_by_edu = mean(salary)) %>% 
  ggplot () +
  geom_col(aes (Education, median_salary_by_edu, fill = gender), position = position_dodge(width = 0.9), alpha = 0.7)+
  geom_point(aes(x = Education, y=mean_salary_by_edu, color = gender))+
  theme_bw()+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+
  NULL


```


## Race (Clara)
### Count 
```{r}
ask_a_manager_2021 %>% 
  group_by(race) %>% 
  filter(n() > 500) %>% 
  summarise(count=n()) %>% 
  ggplot(aes(y=count, x=race, fill=race))+
  geom_col() +
  theme(legend.position = "none") +
  labs(x="Race", y="Count", title="Count by Race", subtitle = "Races with > 500 Respondents")+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) + 
  NULL
```
<<<<<<< HEAD
### Mean Salary


=======

### Race and Mean Salary 

>>>>>>> ad384794db78346e06f0ec0b05171260ea3d105b
```{r}
ask_a_manager_2021 %>% 
  group_by(race) %>% 
  filter(n() > 500) %>% 
  summarise (median_salary_by_race = median (annual_salary),
             mean_salary_by_race = mean(annual_salary)) %>% 
  ggplot(aes(y=median_salary_by_race, x=race, color=race))+
  geom_point() +
  theme(legend.position = "none") +
  labs(x="Race", y="Medium Salary", title="Salary by Race", subtitle = "Races with > 500 Respondents")+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) + 
  NULL

```
### Race and Mean Salary 
```{r}
ask_a_manager_2021 %>% 
  group_by(race) %>% 
  filter(n() > 500) %>% 
  ggplot(aes(y = log(annual_salary), x=race))+
  geom_boxplot() +
  theme_bw()+
  theme(legend.position = "none")+
  labs(title = "Distribution of Annual Salaries by Racial Group",
       x = "Film Rating",
       y = " ")+
  NULL
```

```{r}

```

## Location (Alex)
```{r, }
#This package is useful for creating a map of the USA
library(usmap)
library(ggrepel)

#create df of the list of states with >10 occurrences 
#This allows us to get data for actual states as many data entry errors
#many individuals put multiple states and this helps to fix that
states <- ask_a_manager_2021 %>% 
  group_by(state) %>%
  filter(!is.na(state)) %>%
  filter(n()>10) %>% 
  summarise(mean_salary = mean(salary),
            count_state = count(state))

states$fips <- fips(states$state)
statesalarymap <- states %>% select(state,mean_salary)

plot_usmap(data=statesalarymap, values="mean_salary", color="red") + scale_fill_continuous(
    low = "white",
    high = "red",
    name = "Mean Salary") +
  theme(legend.position = "right") +
  labs(title="Map of US States based on Average Salary")


```

> MAP

```{r}
# Count by Industry

ask_a_manager_2021 %>% 
  group_by(industry) %>% 
  summarise(count=n()) %>% 
  ggplot(aes(y=fct_reorder(industry,count),x=count))+
  geom_col()

# null hypothesis: no difference between
```

## Age (Raina)


## Experience (Raghav)

```{r}
ask_a_manager_2021 %>% 
  group_by() %>% 
  summarise(count=n()) %>% 
  ggplot(aes(y=fct_reorder(industry,count),x=count))+
  geom_col()
```

# Statistical Tests


## Gender vs Salary (Clara)

### General Statistics & Boxplot
```{r}
mosaic::favstats (annual_salary ~ gender, data=ask_a_manager_2021)

```

```{r}
ask_a_manager_2021 %>% 
  ggplot(aes(x=gender,y=log_salary))+
  geom_boxplot()

ask_a_manager_2021

```
***For our following analysis, we will be comparing data from the male gender "Man" with data from the female gender "Woman." We will filter out the data on those that are non binary.***

### T-Test

```{r, t_test_for_gender_salary} }

ask_a_manager_2021 <- ask_a_manager_2021 %>%
  filter(gender!="Non-binary")
t.test(salary ~ gender, data = ask_a_manager_2021)
```

### Confidence Intervals 
```{r, gender vs. salary confidence intervals}
 
#mosaic::favstats (annual_salary ~ gender, data=ask_a_manager_2021)
ask_a_manager_2021_gender <- ask_a_manager_2021 %>%
  mutate(gender2 = case_when(
  gender  == "Man" ~ "1",
 gender == "Woman" ~ "0",
  TRUE ~ "NA"
)) %>%
  mutate(gender2 = as.numeric(gender2))


mosaic::favstats (annual_salary ~ gender, data=ask_a_manager_2021_gender) %>%
mutate(t_critical = qt(0.975,n-1),
         sd_mean = sd/sqrt(n),
         margin_of_error = t_critical*sd_mean,
         ci_lower = mean-margin_of_error,
         ci_higher = mean+margin_of_error)

```
Observation: Since two 95% confidence intervals do not overlap, we are at least 95% confident that the male have higher salary than the female on average.

### Bootstrap Test 
```{r}
# hypothesis testing using infer package
diff <- ask_a_manager_2021_gender %>%
  specify(annual_salary ~ gender) %>%
  calculate(stat = "diff in means", order = c("Woman", "Man"))

set.seed(1234)
salary_in_null_world <- ask_a_manager_2021_gender %>%
  filter(gender !="Non-binary") %>%
  specify(annual_salary ~ gender) %>%
   # assuming independence of gender and salary
  hypothesize(null = "independence") %>%
   # generate 1000 reps, of type "permute"
  generate(reps = 1000, type = "permute") %>%
  # calculate statistic of difference, namely "diff in means"
   calculate(stat = "diff in means", order = c("Woman", "Man")) 

salary_in_null_world %>% 
  visualise()+
  shade_p_value(obs_stat = diff, direction = "two-sided")
  
p_value <- salary_in_null_world %>% 
  get_pvalue(obs_stat = diff, direction="both")
p_value
```
Observation: Our null hypothesis is that the difference of omega between male and female is 0 and we get a p_value very close to 0. Therefore we reject the null hypothesis with 95% confidence. There is difference between the average male and female salary.


## Gender vs Education (Jean)

We want to look at the relationship between one's gender and education degree. 

```{r t_test_for_gender_education}

ask_a_manager_2021 <- ask_a_manager_2021 %>% 
  mutate(high_school = if_else(education == "High School", "Yes", "No")) %>% 
  select(gender,high_school)
  # group_by(gender) %>% 
  # summarise(n=sum(high_school == "Yes"))
  # group_by (gender) %>%
  # summarise (highschool_degree = sum(education == "High School", na.rm = TRUE)/n())

ask_a_manager_2021

prop.test(~gender , data = ask_a_manager_2021, success = "Yes")


```


## Race vs Salary (Raina)

> wisely choose the race. like white vs. not white

## Race vs Education (Jean)

We want to look at the relationship between one's race and education degree. 

```{r t_test_for_race_education}

ask_a_manager_2021 <- ask_a_manager_2021 %>% 
  mutate(if_white = if_else(race == "White", "Yes", "No")) %>% 
  select(if_white,high_school)

ask_a_manager_2021

prop.test(~if_white, data = ask_a_manager_2021, success = "Yes")


```


## Changed Industry? vs salary (Raghav)
```{r}
ask_a_manager_2021_changed <- ask_a_manager_2021  %>%
mutate(if_changed= if_else(overall_years_of_professional_experience == years_of_experience_in_field, "No", "Yes"))
```


```{r}
ask_a_manager_2021_changed %>% 
ggplot(aes(x=overall_years_of_professional_experience, y=annual_salary, color=if_changed))+
  # scatter plot
  geom_point(alpha = 0.5)+
  # linear smooth line
  geom_smooth(method = "lm")+
  # legend settings
  theme(legend.position = "bottom",
        legend.title = element_blank())+
  labs(title="Whether changing job affects your salary",
       x="Total Years Spent Working",
       y="Salary")+
  theme_bw()+
  NULL
prop.test(~if_changed, data = ask_a_manager_2021, success = "Yes")
```
```



# Regression Analysis (Yuan)

```{r}
reg_data <- ask_a_manager_2021 %>% 
  mutate(country = ifelse(country=="US","US","Non-US"))
m1 <- lm(salary ~ education, data=reg_data)
m2 <- lm(salary ~ education+age_group, data=reg_data)
m3 <- lm(salary ~ education+gender, data=reg_data)
m4 <- lm(salary ~ education+gender+country, data=reg_data)


huxreg(m1, m2, m3, m4,
       statistics = c('#observations' = 'nobs', 
                      'R squared' = 'r.squared', 
                      'Adj. R Squared' = 'adj.r.squared', 
                      'Residual SE' = 'sigma'), 
       bold_signif = 0.05, 
       stars = NULL
) %>% 
  set_caption('Comparison of models')

```


